version: "3.9"
name: isekaiexpress

volumes:
  mysql_data:

networks:
  appnet:

services:
  mysql:
    image: mysql:8.0
    container_name: iex_mysql
    command: >
      mysqld --default-authentication-plugin=mysql_native_password
             --character-set-server=utf8mb4
             --collation-server=utf8mb4_unicode_ci
    cap_add:
      - SYS_NICE
    environment:
      TZ: ${TZ:-America/Chicago}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-isekaiexpress}
      MYSQL_USER: ${MYSQL_USER:-isekaiexpress}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-isekaiexpress}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpass}
    volumes:
      - mysql_data:/var/lib/mysql
    ports:
      - "${MYSQL_HOST_PORT:-3307}:3306"
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -p${MYSQL_ROOT_PASSWORD} || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 20
    networks: [appnet]
    restart: unless-stopped

  redis:
    image: redis:7
    container_name: iex_redis
    environment:
      TZ: ${TZ:-America/Chicago}
    healthcheck:
      test: ["CMD-SHELL", "redis-cli ping | grep -q PONG"]
      interval: 5s
      timeout: 3s
      retries: 20
    networks: [appnet]
    restart: unless-stopped

  # ---- One-shot migrator (runs knex, then exits 0) ----
  migrate:
    # Reuse your app image so node_modules & knex CLI are available
    build:
      context: .
      dockerfile: ./docker/Dockerfile.bot
      target: ${BUILD_TARGET:-dev}   # dev|prod
    container_name: iex_migrate
    depends_on:
      mysql: { condition: service_healthy }
    networks: [appnet]
    restart: "no"
    # In dev, bind-mount the repo so migrations in your tree are used live
    volumes:
      - ./:/app
      - /app/node_modules
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      MYSQL_HOST: ${MYSQL_HOST:-mysql}
      MYSQL_PORT: ${MYSQL_PORT:-3306}
      MYSQL_USER: ${MYSQL_USER:-isekaiexpress}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-isekaiexpress}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-isekaiexpress}
    entrypoint: ["sh","-lc","npx knex --knexfile /app/knexfile.js migrate:latest && echo 'migrations ok'"]

  bot:
    container_name: iex_bot
    build:
      context: .
      dockerfile: ./docker/Dockerfile.bot
      target: ${BUILD_TARGET:-dev}
    init: true
    user: "node"
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      TZ: ${TZ:-America/Chicago}
      CHOKIDAR_USEPOLLING: ${CHOKIDAR_USEPOLLING:-true}
      # DB
      MYSQL_HOST: ${MYSQL_HOST:-mysql}
      MYSQL_PORT: ${MYSQL_PORT:-3306}
      MYSQL_USER: ${MYSQL_USER:-isekaiexpress}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-isekaiexpress}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-isekaiexpress}
      # Redis
      REDIS_HOST: ${REDIS_HOST:-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_CONNECT_TIMEOUT_MS: ${REDIS_CONNECT_TIMEOUT_MS:-10000}
      # App secrets & misc
      SESSION_SECRET: ${SESSION_SECRET:?SESSION_SECRET not set}
      DISCORD_BOT_TOKEN: ${DISCORD_BOT_TOKEN:?missing}
      DISCORD_CLIENT_ID: ${DISCORD_CLIENT_ID:?missing}
      DISCORD_CLIENT_SECRET: ${DISCORD_CLIENT_SECRET:?missing}
      DISCORD_GUILD_ID: ${DISCORD_GUILD_ID:-309355248575578113}
      DISCORD_OWNER_ID: ${DISCORD_OWNER_ID:-72884988374167552}
      DISCORD_PREFIX: ${DISCORD_PREFIX:-!}
      DISCORD_APPLICATION_ID: ${DISCORD_APPLICATION_ID:-}
      APP_BASE_URL: ${APP_BASE_URL:-http://localhost:${WEB_PORT:-3000}}
      IMAGE_ARCHIVE_TOKEN: ${IMAGE_ARCHIVE_TOKEN:-}
      FEMBOY_API_KEY: ${FEMBOY_API_KEY:-anonymous}
      FEMBOY_USER_ID: ${FEMBOY_USER_ID:-9455}
      YOUTUBE_API_KEY: ${YOUTUBE_API_KEY:-}
      CURRENCY_API_KEY: ${CURRENCY_API_KEY:-}
      KRAKEN_API_KEY: ${KRAKEN_API_KEY:-}
      KRAKEN_API_SECRET: ${KRAKEN_API_SECRET:-}
      KRAKEN_API_URL: ${KRAKEN_API_URL:-https://api.kraken.com}
    depends_on:
      mysql:   { condition: service_healthy }
      redis:   { condition: service_healthy }
      migrate: { condition: service_completed_successfully }
    networks: [appnet]
    restart: unless-stopped
    profiles: ["dev", "prod"]
    stop_grace_period: 15s
    stop_signal: SIGTERM
    volumes:
      - ./:/app
      - /app/node_modules
    command: ["npx","nodemon","-L",
              "--config","/app/nodemon.json",
              "--watch","/app/src/bot",
              "--exec","npm run start:bot"]

  web:
    container_name: iex_web
    build:
      context: .
      dockerfile: ./docker/Dockerfile.web
      target: ${BUILD_TARGET:-dev}
    init: true
    user: "node"
    depends_on:
      mysql:   { condition: service_healthy }
      redis:   { condition: service_healthy }
      migrate: { condition: service_completed_successfully }
    ports:
      - "${WEB_PORT:-3000}:3000"
    networks: [appnet]
    restart: unless-stopped
    profiles: ["dev", "prod"]
    stop_grace_period: 15s
    stop_signal: SIGTERM
    volumes:
      - ./:/app
      - /app/node_modules
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      TZ: ${TZ:-America/Chicago}
      CHOKIDAR_USEPOLLING: ${CHOKIDAR_USEPOLLING:-true}
      # DB
      MYSQL_HOST: ${MYSQL_HOST:-mysql}
      MYSQL_PORT: ${MYSQL_PORT:-3306}
      MYSQL_USER: ${MYSQL_USER:-isekaiexpress}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-isekaiexpress}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-isekaiexpress}
      # Redis
      REDIS_HOST: ${REDIS_HOST:-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_CONNECT_TIMEOUT_MS: ${REDIS_CONNECT_TIMEOUT_MS:-10000}
      # App
      SESSION_SECRET: ${SESSION_SECRET:?SESSION_SECRET not set}
      APP_BASE_URL: ${APP_BASE_URL:-http://localhost:${WEB_PORT:-3000}}
      SESSION_EXPIRES_DAYS: ${SESSION_EXPIRES_DAYS:-7}
      IMAGE_ARCHIVE_TOKEN: ${IMAGE_ARCHIVE_TOKEN:-}
      FEMBOY_API_KEY: ${FEMBOY_API_KEY:-anonymous}
      FEMBOY_USER_ID: ${FEMBOY_USER_ID:-9455}
      YOUTUBE_API_KEY: ${YOUTUBE_API_KEY:-}
      CURRENCY_API_KEY: ${CURRENCY_API_KEY:-}
      KRAKEN_API_KEY: ${KRAKEN_API_KEY:-}
      KRAKEN_API_SECRET: ${KRAKEN_API_SECRET:-}
      KRAKEN_API_URL: ${KRAKEN_API_URL:-https://api.kraken.com}
    command: ["npx","nodemon","-L",
              "--config","/app/nodemon.json",
              "--watch","/app/src/web",
              "--exec","npm run start:web"]
